/** 
orgy: Globally accessible queues [of deferreds] that wait for an array of dependencies [i.e. files,rpcs,timers,events] and an optional resolver function before settling. Returns a thenable. 
Version: 1.6.3 
Built: 2014-10-10 18:14:53
Author: tecfu.com <help@tecfu.com> (http://github.com/tecfu)  
*/
!function(a,b){b["true"]=a;var c={},d={};c.list={},c.modules_exported=[],c.modules_loaded=0,c.i=0,d.config={autopath:"",document:null,debug_mode:0,cwd:!1,mode:function(){return"object"==typeof process&&process+""=="[object process]"?"node":"browser"}(),hooks:{},timeout:5e3},c.config=function(a){if("object"==typeof a)for(var b in a)d.config[b]=a[b];return d.config},c.define=function(a,b){var e;if(c.list[a]&&1===c.list[a].settled)return c.debug("Can't define "+a+". Already resolved.");b.backtrace=d.get_backtrace_info("public.define"),b.id=b.id||b.__id;var f=b.dependencies||b.__dependencies;return b.resolver=b.resolver||b.__resolver,b.resolver="function"==typeof b.resolver?b.resolver.bind(b):null,"object"==typeof b&&"string"==typeof b.id&&f instanceof Array?(delete b.dependencies,delete b.__dependencies,e=c.queue(f,b)):(e=c.deferred(b),null!==b.resolver||"boolean"==typeof b.autoresolve&&b.autoresolve!==!0||e.resolve(b)),e},c.get=function(a){return c.list[a]?c.list[a]:c.debug(["No instance exists: "+a])},c.assign=function(a,b,d){d="boolean"==typeof d?d:1;var e,f;switch(!0){case"object"==typeof a&&"function"==typeof a.then:e=a.id;break;case"string"==typeof a:e=a;break;default:return c.debug("Assign target must be a queue object or the id of a queue.",this)}if(this.list[e]&&"queue"===this.list[e].model)f=this.list[e],d?f.add(b):f.remove(b);else{if(!d)return c.debug("Cannot remove dependencies from a queue that does not exist.",this);f=c.queue(b,{id:e})}return f},c.naive_cloner=function(a){var b={};for(var c in a)for(var d in a[c])b[d]=a[c][d]instanceof Array?a[c][d].slice(0):"object"==typeof a[c][d]?JSON.parse(JSON.stringify(a[c][d])):a[c][d];return b},c.debug=function(a,b){a instanceof Array||(a=[a]);for(var c in a)console.error("string"==typeof a[c]?"ERROR-"+c+": "+a[c]:a[c]);return b&&(console.log("Backtrace:"),console.log(b.backtrace.stack)),d.config.debug_mode,"browser"===d.config.mode?!1:void process.exit()},d.get_backtrace_info=function(a){var b,c={};return b=c.stack=(new Error).stack,"browser"===d.config.mode?(b=b.split(a)[1].trim().split("\n").pop(),b=window.location.protocol+"//"+b.split("//")[1]):(b=b.split(a+" ")[1].split("\n")[1],b=b.match(/\(([^)]+)\)/)[1]),c.origin=b,c},d.deferred={},c.deferred=function(a){if(a=a||{},a.id&&c.list[a.id])b=c.list[a.id];else{var b=d.deferred.factory(a);b=d.deferred.activate(b)}return b},d.deferred.factory=function(a){var b=c.naive_cloner([d.deferred.tpl,a]);return b.backtrace||(b.backtrace=d.get_backtrace_info("public.deferred")),a.id||(b.id=b.backtrace.origin+"-"+ ++c.i),b},d.deferred.settle=function(a){return a.timeout_id&&clearTimeout(a.timeout_id),d.deferred.set_state(a,1),d.config.hooks.onSettle&&d.config.hooks.onSettle(a),a.callbacks.then.hooks.onComplete.train.push(function(b,c,e){a.caboose=e,d.deferred.run_train(a,a.callbacks.done,a.caboose,{pause_on_deferred:!1})}),d.deferred.run_train(a,a.callbacks.then,a.value,{pause_on_deferred:!0}),a},d.deferred.run_train=function(a,b,c,e){var f=c||a.caboose||a.value;for(b.hooks&&b.hooks.onBefore.train.length>0&&d.deferred.run_train(a,b.hooks.onBefore,c,{pause_on_deferred:!1});b.train.length>0;){var g=b.train.shift();if(a.execution_history.push(g),f=g.call(a,a.value,a,f),e.pause_on_deferred){if(f&&f.then&&1!==f.settled)return void f.callbacks.resolve.hooks.onComplete.train.push(function(){d.deferred.run_train(a,b,c,{pause_on_deferred:!0})});if(f instanceof Array){var h=[];for(var i in f)if(f[i].then&&1!==f[i].settled){h.push(f[i]);var j=function(a,b,c,e){return function(){for(var f in a)if(1!==a[f].settled)return;d.deferred.run_train(b,c,e,{pause_on_deferred:!0})}}(h,a,b,c);return void f[i].callbacks.resolve.hooks.onComplete.train.push(j)}}}}b.hooks&&b.hooks.onComplete.train.length>0&&d.deferred.run_train(a,b.hooks.onComplete,f,{pause_on_deferred:!1})},d.deferred.set_state=function(a,b){a.state=b,(1===b||2===b)&&(a.settled=1),(1===b||2===b)&&d.deferred.signal_downstream(a)},d.deferred.get_state=function(a){return a.state},d.deferred.activate=function(a){return c.list[a.id]&&!c.list[a.id].overwritable?(c.debug("Tried to overwrite "+a.id+" without overwrite permissions."),c.list[a.id]):(c.list[a.id]=a,d.deferred.auto_timeout.call(a),d.config.hooks.onActivate&&d.config.hooks.onActivate(a),a)},d.deferred.auto_timeout=function(a){if(this.timeout="undefined"==typeof a?this.timeout:a,!this.type||"timer"!==this.type){if(this.timeout_id&&clearTimeout(this.timeout_id),"undefined"==typeof this.timeout)c.debug(["Auto timeout this.timeout cannot be undefined.",this.id]);else if(-1===this.timeout)return!1;var b=this;this.timeout_id=setTimeout(function(){d.deferred.auto_timeout_cb.call(b)},this.timeout)}return!0},d.deferred.auto_timeout_cb=function(){if(1!==this.state){var a=[],b=this,c=function(a){return 1!==a.state?a.id:!1};if(d.config.debug_mode){var e=d.deferred.search_obj_recursively(this,"upstream",c);return a.push(b.id+": rejected by auto timeout after "+this.timeout+"ms"),a.push("Cause:"),a.push(e),d.deferred.tpl.reject.call(this,a)}return d.deferred.tpl.reject.call(this)}},d.deferred.error=function(a){return 2===this.state?a():this.reject_q.push(a),this},d.deferred.signal_downstream=function(a){for(var b in a.downstream)if(1===a.downstream[b].settled){if(1!==a.downstream[b].state)continue;c.debug(a.id+" tried to settle promise '"+a.downstream[b].id+"' that has already been settled.")}for(var b in a.downstream)1!==a.downstream[b].settled&&d.queue.receive_signal(a.downstream[b],a.id)},d.deferred.search_obj_recursively=function(a,b,e,f){"undefined"==typeof f&&(f=[a.id]);var g;for(var h in a[b])if(g=e(a[b][h]),g!==!1){if(-1!==f.indexOf(g))return c.debug(["Circular condition in recursive search of obj property '"+b+"' of object "+("undefined"!=typeof a.id?"'"+a.id+"'":"")+". Offending value: "+g,function(){return f.push(g),f.join(" [depends on]=> ")}()]);if(f.push(g),a[b][h][b])return d.deferred.search_obj_recursively(a[b][h],b,e,f);break}return f},d.deferred.convert_to_promise=function(a,b){if(!b.id)if("timer"===b.type)b.id="timer-"+b.timeout+"-"+ ++c.i;else{if("string"!=typeof b.url)return c.debug(["Dependencies without a 'url' property require 'id' property be set.","'"+b.type+"' id undefined.",b]);b.id=b.url.split("/").pop(),-1!==b.id.search(".js")&&(b.id=b.id.split("."),b.id.pop(),b.id=b.id.join("."))}if("timer"!==b.type&&"undefined"!=typeof c.list[b.id]){if(!b.resolver)return c.list[b.id];c.debug(["You can't set a resolver on a queue that has already been declared. You can only reference the original.","Detected re-init of '"+b.id+"'.","Attempted:",b,"Existing:",c.list[b.id]])}var e;switch(!0){case"event"===b.type:e=d.deferred._wrap_event(b);break;case"queue"===b.type:e=c.queue(b.dependencies,b);break;case"deferred"===b.type:case"promise"===b.type||b.then:switch(!0){case"string"==typeof b.id:console.warn("'"+b.id+"': did not exist. Auto creating new deferred."),e=c.deferred({id:b.id});break;case"function"==typeof b.promise:e=b.scope?b.promise.call(b.scope):b.promise();break;case b.then:e=b}if("object"!=typeof e||!e.then)return c.debug("Dependency labeled as a promise did not return a promise.",b);break;case"timer"===b.type:e=d.deferred._wrap_timer(b);break;default:b.type=b.type||"default",a.cwd&&(b.cwd=a.cwd),e=d.deferred._wrap_xhr(b)}return c.list[b.id]=e,e},d.deferred._wrap_event=function(a){var b=c.deferred({id:a.id});if("undefined"!=typeof document&&"undefined"!=typeof window)if("function"!=typeof $){var d="window and document based events depend on jQuery";b.reject(d)}else switch(!0){case"ready"===a.id||"DOMContentLoaded"===a.id:$(document).ready(function(){b.resolve(1)});break;case"load"===a.id:$(window).load(function(){b.resolve(1)});break;default:$(document).on(a.id,"body",function(){b.resolve(1)})}return b},d.deferred._wrap_timer=function(a){var b=c.deferred(a);return function(b){var c=(new Date).getTime();setTimeout(function(){var d=(new Date).getTime();b.resolve({start:c,end:d,elapsed:d-c,timeout:a.timeout})},a.timeout)}(b),b},d.deferred._wrap_xhr=function(a){var b=["id","url"];for(var e in b)if(!a[b[e]])return c.debug(["File requests converted to promises require: "+b[e],"Make sure you weren't expecting dependency to already have been resolved upstream.",a]);if(c.list[a.id])return c.list[a.id];var f;return f=c.deferred(a),f=d.deferred.attach_xhr(f,a)},d.deferred.attach_xhr=function(a,b){function e(a,b,c){switch(!0){case"json"===c.type:b=JSON.parse(b),a.resolve(b);break;default:a.resolve(b)}}if("object"!=typeof process||process+""!="[object process]")switch("."===b.url[0]&&"/"===b.url[1]&&(b.url=b.url.substring(1)),this.head=this.head||document.getElementsByTagName("head")[0]||document.documentElement,!0){case"script"===b.type:var f=document.createElement("script");f.type="text/javascript",f.setAttribute("src",b.url),f.setAttribute("id",b.id),function(a,b,c){a.onload=a.onreadystatechange=function(){("boolean"!=typeof c.autoresolve||c.autoresolve===!0)&&c.resolve("undefined"!=typeof a.value?a.value:a)},a.onerror=function(){c.reject("Error loading: "+b.url)}}(f,b,a),this.head.appendChild(f);break;case"css"===b.type||"link"===b.type:var f=document.createElement("link");if(f.setAttribute("href",b.url),f.setAttribute("type","text/css"),f.setAttribute("rel","stylesheet"),f.onload){!function(a,b,c){a.onload=a.onreadystatechange=function(){c.resolve(a)},a.onerror=function(){c.reeject("Failed to load path: "+b.url)}}(f,b,a),this.head.appendChild(f);break}this.head.appendChild(f);case"json"===b.type:default:var g,h=new XMLHttpRequest;h.open("GET",b.url,!0),"undefined"!=typeof b.show_messages&&h.setRequestHeader("show-messages",b.show_messages),"undefined"!=typeof b.return_packet&&h.setRequestHeader("return-packet",b.return_packet),function(a,b){h.onreadystatechange=function(){if(4===h.readyState)if(200===h.status){if(g=h.responseText,"json"===a.type)try{g=JSON.parse(g)}catch(d){c.debug(["Could not decode JSON",a.url,g],b)}b.resolve(f||g)}else b.reject("Error loading: "+a.url)}}(b,a),h.send(null)}else if(b.remote){var i=require("request");i.get(b.url,function(c,d,f){c||200!=d.statusCode||e(a,f,b)})}else{var j=process.cwd(),k=a.cwd?a.cwd:d.config.cwd?d.config.cwd:!1,l=!1;k?(process.chdir(k),l=!0):k=process.cwd();var m=k+"/"+b.url;if("script"===b.type){var n=require(m);("boolean"!=typeof a.autoresolve||a.autoresolve===!0)&&a.resolve(n)}else if("css"===b.type){if(null===d.config.document)return c.debug([b.url,"Must pass html document to Orgy.config() before attempting to add DOM nodes [i.e. css] as dependencies."],a);var f=d.config.document("head").append('<link rel="stylesheet" href="'+b.url+'" type="text/css" />');a.resolve(f)}else{var o=require("fs");!function(a,b){o.readFile(m,"utf8",function(d,f){d&&(c.debug(["File "+b.url+" not found @ local dep.url '"+b.url+"'","CWD: "+process.cwd()],a),process.exit()),e(a,f,b)})}(a,b)}l&&process.chdir(j)}return a},d.deferred.tpl={},d.deferred.tpl.id=null,d.deferred.tpl.settled=0,d.deferred.tpl.state=0,d.deferred.tpl.value=[],d.deferred.tpl.caboose=null,d.deferred.tpl.model="deferred",d.deferred.tpl.done_fired=0,d.deferred.tpl.timeout_id=null,d.deferred.tpl.callback_states={resolve:0,then:0,done:0,reject:0},d.deferred.tpl.callbacks=function(){var a={};for(var b in d.deferred.tpl.callback_states)a[b]={train:[],hooks:{onBefore:{train:[]},onComplete:{train:[]}}};return a}(),d.deferred.tpl.downstream={},d.deferred.tpl.execution_history=[],d.deferred.tpl.overwritable=0,d.deferred.tpl.timeout=d.config.timeout,d.deferred.tpl.remote=1,d.deferred.tpl.list=1,d.deferred.tpl.resolve=function(a){return 1===this.settled&&c.debug([this.id+" can't resolve.","Only unsettled deferreds are resolvable."]),d.deferred.set_state(this,-1),this.value=a,this.resolver_fired||"function"!=typeof this.resolver?(this.resolver_fired=1,this.callbacks.resolve.hooks.onComplete.train.unshift(function(){d.deferred.settle(this)})):(this.resolver_fired=1,this.callbacks.resolve.train.push(function(){this.resolver(a,this)})),d.deferred.run_train(this,this.callbacks.resolve,this.value,{pause_on_deferred:!1}),this},d.deferred.tpl.reject=function(a){a instanceof Array||(a=[a]);var b="Rejected "+this.model+": '"+this.id+"'.";return d.config.debug_mode?(a.unshift(b),c.debug(a,this)):(b+="\n Turn debug mode on for more info.",console.log(b)),this.timeout_id&&clearTimeout(this.timeout_id),d.deferred.set_state(this,2),d.deferred.run_train(this,this.callbacks.reject,a,{pause_on_deferred:!1}),this},d.deferred.tpl.then=function(a,b){switch(!0){case 2===this.state:break;case 1===this.done_fired:return c.debug(this.id+" can't attach .then() because .done() has already fired, and that means the execution chain is complete.");default:this.callbacks.then.train.push(a),"function"==typeof b&&this.callbacks.reject.train.push(b),1!==this.settled||1!==this.state||this.done_fired||d.deferred.run_train(this,this.callbacks.then,this.caboose,{pause_on_deferred:!0})}return this},d.deferred.tpl.done=function(a,b){if(0!==this.callbacks.done.train.length||0!==this.done_fired)return c.debug("done() can only be called once.");if("function"!=typeof a)return c.debug("done() must be passed a function.");var e=function(b,c,d){c.done_fired=1,a(b,c,d)};this.callbacks.done.train.push(e),"function"==typeof b&&this.callbacks.reject.hooks.onComplete.train.push(b),1===this.settled&&(1===this.state?d.deferred.run_train(this,this.callbacks.done,this.caboose,{pause_on_deferred:!1}):d.deferred.run_train(this,this.callbacks.reject,this.caboose,{pause_on_deferred:!1}))},c.queue={},d.queue={},d.queue.tpl={model:"queue",resolver_fired:0,halt_resolution:0,upstream:{},dependencies:[],add:function(a){try{if(0===a.length)return this.upstream}catch(b){c.debug(b)}if(0!==this.state)return c.debug("Cannot add list to queue id:'"+this.id+"'. Queue settled/in the process of being settled.",this);for(var e in a){switch(!0){case"object"==typeof c.list[a[e].id]:a[e]=c.list[a[e].id];break;case"object"==typeof a[e]&&"function"!=typeof a[e].then:a[e]=d.deferred.convert_to_promise(this,a[e]);break;case"function"==typeof a[e].then:break;default:console.error("Object could not be converted to promise."),console.error(a[e]);continue}for(var f in this.downstream)if(f===a[e].id)return c.debug("Error adding upstream dependency '"+a[e].id+"' to queue '"+this.id+"'.\n Promise object for '"+a[e].id+"' is scheduled to resolve downstream from queue '"+this.id+"' so it can't be added upstream.");this.upstream[a[e].id]=a[e],a[e].downstream[this.id]=this,this.dependencies.push(a[e])}return this.upstream},remove:function(a){if(0!==this.state)return c.debug("Cannot remove list from queue id:'"+this.id+"'. Queue settled/in the process of being settled.");for(var b in a)this.upstream[a[b].id]&&(delete this.upstream[a[b].id],delete a[b].downstream[this.id])},reset:function(a){return 1!==this.settled||1!==this.state?c.debug("Can only reset a queue settled without errors."):(a=a||{},this.settled=0,this.state=0,this.resolver_fired=0,this.done_fired=0,this.timeout_id&&clearTimeout(this.timeout_id),this.downstream={},this.dependencies=[],d.deferred.auto_timeout.call(this,a.timeout),this)},check_self:function(){return d.queue.receive_signal(this,this.id),this.state}},c.queue=function(a,b){var e;if(!(a instanceof Array))return c.debug("Queue dependencies must be an array.");if(b=b||{},c.list[b.id]){if(e=c.list[b.id],"queue"!==e.model)b.overwritable=1,e=d.queue.upgrade(e,b,a);else{for(var f in b)e[f]=b[f];a.length>0&&d.queue.tpl.add.call(e,a)}e.halt_resolution="undefined"!=typeof b.halt_resolution?b.halt_resolution:0}else{var e=d.queue.factory(b);e=d.queue.activate(e,b,a)}return e},d.queue.factory=function(a){var b=c.naive_cloner([d.deferred.tpl,d.queue.tpl,a]);return b.backtrace||(b.backtrace=d.get_backtrace_info("public.queue")),a.id||(b.id=b.backtrace.origin+"-"+ ++c.i),b},d.queue.activate=function(a,b,e){if(a=d.deferred.activate(a),d.queue.tpl.add.call(a,e),d.queue.receive_signal(a,a.id),a.assign)for(var f in a.assign)c.assign(a.assign[f],[a],!0);return a},d.queue.receive_signal=function(a,b){if(1!==a.halt_resolution){if(b!==a.id&&!a.upstream[b])return c.debug(b+" can't signal "+a.id+" because not in upstream.");var e=1;for(var f in a.upstream)if(1!==a.upstream[f].state){e=a.upstream[f].state;break}if(1===e){var g=[];for(var f in a.dependencies)g.push(a.dependencies[f].value);d.deferred.tpl.resolve.call(a,g)}if(2===e){var h=[a.id+" dependency '"+a.upstream[f].id+"' was rejected.",a.upstream[f].arguments];d.deferred.tpl.reject.apply(a,h)}}},d.queue.upgrade=function(a,b,e){if(0!==a.settled||"promise"!==a.model&&"deferred"!==a.model)return c.debug("Can only upgrade unsettled promise or deferred into a queue.");var f=c.naive_cloner([d.queue.tpl,b]);for(var g in f)a[g]=f[g];return delete f,a=d.queue.activate(a,b,e)},c.cast=function(a){var b=["then","error"];for(var d in b)if(!a[b[d]])return c.debug("Castable objects require: "+b[d]);var e={};a.id?e.id=a.id:a.url&&(e.id=a.url);var f=c.deferred(e),g=function(){f.resolve.call(f,arguments[0])};a.then(g);var h=function(a){f.reject(a)};return a.error(h),f},"object"==typeof process&&process+""=="[object process]"?module.exports=c:Orgy=c}({},function(){return this}());