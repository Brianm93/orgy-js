/** 
orgy: A queue and deferred library that is so very hot right now. 
Version: 1.2.0 
Built: 2014-08-25 
Author: tecfu.com  
*/
var public={},private={};public.list={},public.modules_exported=[],public.modules_loaded=0,public.registered_callbacks={},public.i=0,public.config=function(a){if(a)for(var b in a){if("undefined"==typeof private.config[b])return public.debug("Property '"+b+"' is not configurable.");private.config[b]=a[b]}return private.config},public.define=function(a,b){var c;return public.list[a]&&1===public.list[a].settled?public.debug("Can't define "+a+". Already resolved.",!0):("object"==typeof b&&b.__dependencies instanceof Array?(c=function(){return public.queue(b.__dependencies,{id:a,resolver:"function"==typeof b.__resolver?b.__resolver.bind(b):null})}(c),c._is_orgy_module=1):(c=public.deferred({id:a}),c.resolve(b)),c)},public.assign=function(a,b,c){c="boolean"==typeof c?c:1;var d,e;switch(!0){case"object"==typeof a&&"function"==typeof a.then:d=a.id;break;case"string"==typeof a:d=a;break;default:return public.debug("Assign target must be a queue object or the id of a queue.")}return this.list[d]&&"queue"===this.list[d].model?(e=this.list[d],c?e.add(b):e.remove(b)):c?e=public.queue(b,{id:d}):public.debug("Cannot remove dependencies from a queue that does not exist."),e},public.register_callback=function(a,b){public.registered_callbacks[a]=b},public.array_to_function=function(a){var b=a.slice(0),c=b[0];b.splice(0,1);var d;d=public.list[c]&&public.list[c].hasOwnProperty("value")?public.list[c].value:window[c],"undefined"==typeof d&&console.error(c+" not found on window or public.list");var e,f;e=f=d;var g,h=b.length,i=b[h-1];g=i instanceof Array?h-1:h;for(var j,k=0;g>k;k++){var l=b[k];if((k===g-1||1===h)&&(j=e),"undefined"==typeof e[l])return void console.error("Property '"+l+"' not found on object:",e);e=e[l],f=e}return{constructor:e,args:i,parent:j}},public.naive_cloner=function(a){var b={};for(var c in a)for(var d in a[c])b[d]=a[c][d]instanceof Array?a[c][d].slice(0):"object"==typeof a[c][d]?JSON.parse(JSON.stringify(a[c][d])):a[c][d];return b},public.debug=function(a,b){if(a instanceof Array)for(var c in a)console.error("ERROR-"+c+": "+a[c]);else console.error("ERROR: "+a);return 1==private.config.debug_mode||b,"browser"===private.config.mode?!1:void process.exit()},private.config={autopath:"",document:null,debug_mode:1,mode:function(){return"object"==typeof process&&process+""=="[object process]"?"node":"browser"}()},public.deferred=function(a){if(!a||"string"!=typeof a.id)return public.debug("Must set id.");if(public.list[a.id])b=public.list[a.id];else{var b=private.deferred.factory(a);b=private.deferred.activate(b)}return b},private.deferred={factory:function(a){var b=public.naive_cloner([private.deferred.tpl,a]);return b},tpl:{model:"deferred",settled:0,id:null,done_fired:0,_is_orgy_module:0,_state:0,_timeout_id:null,value:[],error_q:[],then_q:[],done_fn:null,reject_q:[],downstream:{},execution_history:[],overwritable:0,timeout:5e3,remote:1,list:1,resolve:function(a){if(0!==this.settled&&public.debug(this.id+" can't resolve. Only unsettled promise objects resolvable."),this._state=-1,this.value=a,!this.resolver_fired&&(this.resolver_fired=1,"function"==typeof this.resolver))return private.deferred.hook_before_success.call(this,this.resolver,a);for(var b,c,d=this.then_q.length,e=0;d>e;e++){if(c=this.then_q.splice(0,1),b=private.deferred.hook_before_success.call(this,c[0],b||this.value),this.execution_history.push(c[0]),"undefined"!=typeof b&&b.then)return this._state=0,void this.add([b]);"undefined"!=typeof b&&(this.value=b)}if(this.set)if(this.set instanceof Array){var f=public.array_to_function(this.set);f.parent[f.args]=this.value}else"function"==typeof this.set&&this.set(this.value);for(var e in public.registered_callbacks)console.log("Orgy.js executing registered callback '"+e+"' on "+this.id),public.registered_callbacks[e].call(this);return this._timeout_id&&clearTimeout(this._timeout_id),private.deferred._set_state.call(this,1),this.done(),this},reject:function(a){a instanceof Array||(a=[a]),a.unshift("REJECTED "+this.model+": '"+this.id+"'"),public.debug(a),this._timeout_id&&clearTimeout(this._timeout_id),this.catch_params=a,private.deferred._set_state.call(this,2);for(var b in this.reject_q)this.value.push(this.reject_q[b].apply(this,arguments));return this},then:function(a,b){switch(!0){case 2===this._state:break;case 1===this.done_fired:public.debug(this.id+" can't attach .then() after .done() has fired.");break;case 1===this.settled&&1===this._state&&!this.done_fired:var c=private.deferred.hook_before_success.call(this,a,this.value);"undefined"!=typeof c&&(this.value=c);break;default:this.then_q.push(a),"function"==typeof b&&this.reject_q.push(b)}return this},done:function(a){if(null===this.done_fn)a&&(this.done_fn=a);else if(a)return void public.debug("done() can only be called once.");1===this.settled&&1===this._state&&this.done_fn&&(this.done_fired=1,private.deferred.hook_before_success.call(this,this.done_fn,this.value))}},hook_before_success:function(a,b){return a(b,this)},_set_state:function(a){this._state=a,(1===a||2===a)&&(this.settled=1),private.deferred._signal_downstream.call(this,this)},_get_state:function(){return this._state},activate:function(a){return a.id||(a.id=private.deferred._make_id(a.model),a.autonamed=!0),public.list[a.id]&&!public.list[a.id].overwritable?(public.debug("Tried to overwrite "+a.id+" without overwrite permissions."),public.list[a.id]):(public.list[a.id]=a,private.deferred.auto_timeout.call(a),a)},auto_timeout:function(a){if(this.timeout="undefined"==typeof a?this.timeout:a,!this.type||"timer"!==this.type){if(this._timeout_id&&clearTimeout(this._timeout_id),"undefined"==typeof this.timeout)public.debug(this.id+" Auto timeout this.timeout cannot be undefined.");else if(-1===this.timeout)return!1;var b=this;this._timeout_id=setTimeout(function(){private.deferred.auto_timeout_cb.call(b)},this.timeout)}return!0},auto_timeout_cb:function(){if(1!==this._state){var a=[],b=this,c=function(a){return 1!==a._state?a.id:!1},d=private.deferred.search_obj_recursively(this,"upstream",c);return a.push(b.id+": rejected by auto timeout after "+this.timeout+"ms"),a.push("Cause:"),a.push(d),private.deferred.tpl.reject.call(this,a)}},error:function(a){return 2===this._state?a():this.error_q.push(a),this},_make_id:function(a){return"anonymous-"+a+"-"+public.i++},_signal_downstream:function(a){for(var b in a.downstream)1===a.downstream[b].settled&&public.debug(a.id+" tried to settle promise '"+a.downstream[b].id+"' that has already been settled.");for(var b in a.downstream)1!==a.downstream[b].settled&&private.queue.receive_signal(a.downstream[b],a.id)},search_obj_recursively:function(a,b,c,d){"undefined"==typeof d&&(d=[a.id]);var e;for(var f in a[b])if(e=c(a[b][f]),e!==!1){if(-1!==d.indexOf(e))return public.debug(["Circular condition in recursive search of obj property '"+b+"'. Offending value: "+e,d]);if(d.push(e),a[b][f][b])return private.deferred.search_obj_recursively(a[b][f],b,c,d);break}return d},convert_to_promise:function(a){if(!a.id)if("timer"===a.type)a.id="timer-"+a.timeout+"-"+public.i++;else{if("string"!=typeof a.url)return public.debug(["Dependency type '"+a.type+"' requires id, but id undefined.",a]);a.id=a.url.split("/").pop(),-1!==a.id.search(".js")&&(a.id=a.id.split("."),a.id.pop(),a.id=a.id.join("."))}if("timer"!==a.type&&"undefined"!=typeof public.list[a.id])return public.list[a.id];var b;switch(!0){case"event"===a.type:b=private.deferred._wrap_event(a);break;case"deferred"===a.type:case"promise"===a.type||a.then:switch(!0){case"function"==typeof a.promise:b=a.scope?a.promise.call(a.scope):a.promise();break;case a.then:b=a;break;case"string"==typeof a.id:public.list[a.id]?b=public.list[a.id]:(console.warn("Promise '"+a.id+"': did not exist. Auto creating new deferred."),b=public.deferred({id:a.id}))}if("object"!=typeof b||!b.then)return public.debug("Dependency labeled as a promise did not return a promise.",a);break;case"timer"===a.type:b=private.deferred._wrap_timer(a);break;default:a.type=a.type||"default",b=private.deferred._wrap_xhr(a)}return public.list[a.id]=b,b},_wrap_event:function(a){var b=public.deferred({id:a.id});if("undefined"!=typeof document&&"undefined"!=typeof window)if("function"!=typeof $){var c="window and document based events depend on jQuery";b.reject(c)}else switch(!0){case"ready"===a.id||"DOMContentLoaded"===a.id:$(document).ready(function(){b.resolve(1)});break;case"load"===a.id:$(window).load(function(){b.resolve(1)});break;default:$(document).on(a.id,"body",function(){b.resolve(1)})}return b},_wrap_timer:function(a){var b=public.deferred(a);return function(b){var c=(new Date).getTime();setTimeout(function(){var d=(new Date).getTime();b.resolve({start:c,end:d,elapsed:d-c,timeout:a.timeout})},a.timeout)}(b),b},_wrap_xhr:function(a){var b=["id","url"];for(var c in b)if(!a[b[c]])return public.debug("File requests converted to promises require: "+b[c]);if(public.list[a.id])return public.list[a.id];var d;return d=public.deferred(a),d=private.deferred.attach_xhr(d,a)},attach_xhr:function(a,b){function c(a,b,c){switch(!0){case"json"===c.type:b=JSON.parse(b),a.resolve(b);break;default:a.resolve(b)}}if("*"===b.url[0]){var d=Orgy.config().autopath;"string"!=typeof d?public.debug(["config.autopath must be set to a string."],["When a dependency url begins with *, it is replaced by the config property 'autopath'."]):b.url=b.url.replace(/\*/,d)}if("object"!=typeof process||process+""!="[object process]")switch(this.head=this.head||document.getElementsByTagName("head")[0]||document.documentElement,!0){case"script"===b.type:var e=document.createElement("script");e.type="text/javascript",e.setAttribute("src",b.url),e.setAttribute("id",b.id),function(a,b,c){a.onload=a.onreadystatechange=function(){c._is_orgy_module||c.resolve("undefined"!=typeof a.value?a.value:a)},a.onerror=function(){c.reject("Failed to load path: "+b.url)}}(e,b,a),this.head.appendChild(e);break;case"css"===b.type||"link"===b.type:var e=document.createElement("link");if(e.setAttribute("href",b.url),e.setAttribute("type","text/css"),e.setAttribute("rel","stylesheet"),e.onload){!function(a,b,c){a.onload=a.onreadystatechange=function(){c.resolve(a)},a.onerror=function(){c.reeject("Failed to load path: "+b.url)}}(e,b,a),this.head.appendChild(e);break}this.head.appendChild(e);case"json"===b.type:default:var f,g=new XMLHttpRequest;g.open("GET",b.url,!0),"undefined"!=typeof b.show_messages&&g.setRequestHeader("show-messages",b.show_messages),"undefined"!=typeof b.return_packet&&g.setRequestHeader("return-packet",b.return_packet),function(a,b){g.onreadystatechange=function(){if(4===g.readyState)if(200===g.status){if(f=g.responseText,"json"===a.type)try{f=JSON.parse(f)}catch(c){public.debug(["Could not decode JSON",a.url,f])}b.resolve(e||f)}else b.reject("Error loading "+a.url)}}(b,a),g.send(null)}else if(b.remote){var h=require("request");h.get(b.url,function(d,e,f){d||200!=e.statusCode||c(a,f,b)})}else if("script"===b.type){var i=require(b.url);a._is_orgy_module||a.resolve(i)}else if("css"===b.type){if(null===private.config.document)return public.debug([b.url,"Must pass html document to Orgy.config() before attempting to add DOM nodes [i.e. css] as dependencies."]);var e=private.config.document("head").append('<link rel="stylesheet" href="'+b.url+'" type="text/css" />');a.resolve(e)}else{var j=require("fs");!function(a,b){j.readFile(b.url,"utf8",function(d,e){d&&(public.debug(["File "+b.url+" not found @ local dep.url '"+b.url+"'","CWD: "+process.cwd()]),process.exit()),c(a,e,b)})}(a,b)}return a}},public.queue=function(a,b){var c;if(!(a instanceof Array))return public.debug("Queue dependencies must be an array.");if(!b||!b.id)return public.debug("Queues require an id.");if(public.list[b.id]){if(c=public.list[b.id],"queue"!==c.model)b.overwritable=1,c=private.queue.upgrade(c,b,a);else{for(var d in b)c[d]=b[d];a.length>0&&private.queue.tpl.add.call(c,a)}c.halt_resolution="undefined"!=typeof b.halt_resolution?b.halt_resolution:0}else{var c=private.queue.factory(b);c=private.queue.activate(c,b,a)}return c},private.queue={factory:function(a){var b=public.naive_cloner([private.deferred.tpl,private.queue.tpl,a]);return b},tpl:{model:"queue",resolver_fired:0,halt_resolution:0,upstream:{},dependencies:[],add:function(a){try{if(0===a.length)return this.upstream}catch(b){public.debug(b)}if(0!==this._state)return public.debug("Cannot add list to queue id:'"+this.id+"'. Queue settled/in the process of being settled.");for(var c in a){switch(!0){case"string"==typeof a[c]:if(!public.list[a[c]])return public.debug(a[c]+"' does not exist so cannot be added to a queue.");a[c]=public.list[a[c]];break;case"object"==typeof a[c]&&"function"!=typeof a[c].then:a[c]=private.deferred.convert_to_promise(a[c]);break;case"function"==typeof a[c].then:break;default:console.error("Object could not be converted to promise."),console.error(a[c]);continue}for(var d in this.downstream)if(d===a[c].id)return public.debug("Error adding upstream dependency '"+a[c].id+"' to queue '"+this.id+"'.\n Promise object for '"+a[c].id+"' is scheduled to resolve downstream from queue '"+this.id+"' so it can't be added upstream.");this.upstream[a[c].id]=a[c],a[c].downstream[this.id]=this,this.dependencies.push(a[c])}return this.upstream},remove:function(a){if(0!==this._state)return console.error("Cannot remove list from queue id:'"+this.id+"'. Queue settled/in the process of being settled."),!1;for(var b in a)this.upstream[a[b].id]&&(delete this.upstream[a[b].id],delete a[b].downstream[this.id])},reset:function(a){return(1!==this.settled||1!==this._state)&&public.debug("Can only reset a queue settled without errors."),a=a||{},this.settled=0,this._state=0,this.resolver_fired=0,this.done_fired=0,this._timeout_id&&clearTimeout(this._timeout_id),this.downstream={},this.dependencies=[],private.deferred.auto_timeout.call(this,a.timeout),this},check_self:function(){return private.queue.receive_signal(this,this.id),this._state}},activate:function(a,b,c){if(a=private.deferred.activate(a),private.queue.tpl.add.call(a,c),private.queue.receive_signal(a,a.id),a.assign)for(var d in a.assign)public.assign(a.assign[d],[a],!0);return a},receive_signal:function(a,b){if(1!==a.halt_resolution){if(b!==a.id&&!a.upstream[b])return void console.error(b+" can't signal "+a.id+" because not in upstream.");var c=1;for(var d in a.upstream)if(1!==a.upstream[d]._state){c=a.upstream[d]._state;break}if(1===c){var e=[];for(var d in a.dependencies)e.push(a.dependencies[d].value);private.deferred.tpl.resolve.call(a,e)}if(2===c){var f=[a.id+" dependency '"+a.upstream[d].id+"' was rejected.",a.upstream[d].arguments];private.deferred.tpl.reject.apply(a,f)}}},upgrade:function(a,b,c){if(0!==a.settled||"promise"!==a.model&&"deferred"!==a.model)return public.debug("Can only upgrade unsettled promise or deferred into a queue.");var d=public.naive_cloner([private.queue.tpl,b]);for(var e in d)a[e]=d[e];return delete d,a=private.queue.activate(a,b,c)}},public.cast=function(a){var b=["then","error","id"];for(var c in b)if(!a[b[c]])return public.debug("Castable objects require: "+b[c]);var d=public.deferred({id:a.id}),e=function(){d.resolve.call(d,arguments[0])};a.then(e);var f=function(a){d.reject(a)};return a.error(f),d},"object"==typeof process&&process+""=="[object process]"?module.exports=public:Orgy=public;